$(document).ready(function() {
	
	// Đóng popup thông báo giỏ hàng
	$('body').on('click', '*[data-cart_popup_close]', function(e) {
		e.preventDefault();
		e.stopImmediatePropagation();
		$('body').css('overflow', 'auto');
		$(this).closest('.open').removeClass('open');
	});

	// Click bấm vào nút xác nhận tại thông báo xoá giỏ hàng
	$('body').on('click', '*[data-cart_delete_all_popup]', function(e) {
		e.preventDefault();
		e.stopImmediatePropagation();
		$('#cart-delete').addClass('open');
		$('body').css('overflow', 'hidden');
		$('*[data-cart_delete_all]').attr('data-cart_delete_all', 'all').data('cart_delete_all', 'all');
	});
	$('body').on('click', '*[data-cart_delete_one_popup]', function(e) {
		e.preventDefault();
		e.stopImmediatePropagation();
		$('#cart-delete').addClass('open');
		$('body').css('overflow', 'hidden');
		$('*[data-cart_delete_all]').attr('data-cart_delete_all', 'one').data('cart_delete_all', 'one');
		// Lấy rowId từ thẻ tr cha và thêm vào thẻ xoá
		rowId = $(this).closest('tr[data-rowid]').data('rowid');
		$('*[data-cart_delete_all]').attr('data-rowid', rowId).data('rowid', rowId);
	});
	$('body').on('click', '*[data-cart_delete_all]', function(e) {
		e.preventDefault();
		e.stopImmediatePropagation();
		data = {
			type: $(this).data('cart_delete_all'),
			rowId: $(this).data('rowid'),
		};
		loadAjaxCart('/ajax/shopping_cart/destroy', data, {
	        beforeSend: function(){},
	        success:function(result){
	        	if (result.status == 1) {
	        		$('#cart-count').text(result.total_quantity);
					// Ẩn modal
					$('#cart-delete').removeClass('open');
					$('body').css('overflow', 'auto');
					if (result.total_quantity == 0) {
						// Hiển thị box giỏ hàng trống
						$('.cart').find('.cart-empty').fadeIn();
						$('.cart').find('.cart-title').remove();
						$('.cart').find('.cart-content').remove();
						$('.cart').find('.cart-checkout').remove();
					}
					// ẩn tr đã xoá
					if (result.rowId) {
						$('tr[data-rowid='+rowId+']').fadeOut(function() {
							$(this).remove();
							$('#cart-total').html(cartPrice(result.total_price));
						});
					}
	        	} else {
	        		cartAlert(result.message);
	        	}
	        },
	        error: function (error) {}
	    });
	});

	$('body').on('click', '.cart-update', function(e) {
		e.preventDefault();
		e.stopImmediatePropagation();
		e = $(this);
		type = 'plus';
		rowId = e.closest('tr[data-rowid]').data('rowid');
		if (e.hasClass('cart-minus')) {
			type = 'minus';
		}
		loadAjaxCart('/ajax/shopping_cart/update', { type: type, rowId: rowId }, {
			beforeSend: function(){},
	        success:function(result){
	        	if (result.status == 1) {
	        		row = e.closest('tr[data-rowid]');
	        		price = parseInt(result.data.price);
	        		qty = parseInt(result.data.qty);
	        		$(row).find('.cart-table__subtotal').html(cartPrice(price*qty));
	        		$(row).find('input[name=quantity]').val(qty);
	        		$('#cart-total').html(cartPrice(result.total_price));
	        		$('#cart-count').text(result.total_quantity);
	        	} else {
	        		cartAlert(result.message);
	        	}
	        },
	        error: function (error) {}
		});
	});
});

/*
    loadAjaxCart(url, params, {
        beforeSend: function(){},
        success:function(result){},
        error: function (error) {}
    });
*/
function loadAjaxCart(url, params, option){
    var _option = {
        beforeSend:function(){},
        success:function(){},
        error:function(){}
    }
    $.extend(_option,option);
    $.ajax({
        headers: {
            'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
        },
        type: 'POST',
        url: url,
        data: params,
        beforeSend: function(){
            $(".cart-loading").css({visibility:"visible", opacity: 0.0}).animate({opacity: 1.0},200);
            _option.beforeSend();
        },
        success:function(result){
            $(".cart-loading").animate({opacity: 0.0}, 200, function(){
	            $(".cart-loading").css("visibility","hidden");
	        });
            _option.success(result);
        },
        error: function (error) {
            /* Có lỗi sẽ ân Module Loading và thông báo */
            $(".cart-loading").animate({opacity: 0.0}, 200, function(){
	            $(".cart-loading").css("visibility","hidden");
	        });
	        cartAlert('Có lỗi xảy ra. Vui lòng thử lại.');
            _option.error(error);
        }
    })
}
// Thông báo
function cartAlert(text) {
	$('#cart-notificate').find('.cart-popup__body__notificate').html(text);
	$('#cart-notificate').addClass('open');
	$('body').css('overflow', 'hidden');
}

// Định dạng giá
function cartPrice(number) {
	number += '';
    x = number.split('.');
    x1 = x[0];
    x2 = x.length > 1 ? '.' + x[1] : '';
    var rgx = /(\d+)(\d{3})/;
    while (rgx.test(x1)) {
        x1 = x1.replace(rgx, '$1' + '.' + '$2');
    }
    number = x1 + x2 +"đ";
    return number;
}
$(document).ready(function() {
	
	/**
	 * Nút thêm vào giỏ hàng chỉ cần có thuộc tính là "add_to_cart" có giá trị là ID của sản phẩm
	 * Để thêm số lượng chúng ta sử dụng thêm thuộc tính "add_to_cart_quantity" có giá trị là Định dạng thẻ input set số lượng
	 */
	$('body').on('click', '*[add_to_cart]', function(e) {
		e.preventDefault();
		e.stopImmediatePropagation();
		// Mặc định số lượng là 1
		quantity = 1;
		// ID sản phẩm
		product_id = $(this).attr('add_to_cart');
		// Thẻ input quantity
		quantity_el = $(this).attr('add_to_cart_quantity');
		// Nếu có thẻ và giá trị của thẻ lớn hơn 0 thì set lại số lượng muốn thêm
		if ($(quantity_el).length > 0) {
			if ($(quantity_el).val() > 0) {
				quantity = $(quantity_el).val();
			}
		}
		// Dữ liệu thêm vào giỏ
		data = {
			product_id: product_id,
			quantity: quantity,
		};
		addCart(data);
	});

	// Đóng popup thông báo giỏ hàng
	$('body').on('click', '*[data-cart_popup_close]', function(e) {
		e.preventDefault();
		e.stopImmediatePropagation();
		$('body').css('overflow', 'auto');
		$(this).closest('.open').removeClass('open');
	});

});

function addToCart(e, product_id, quantity_el) {
	e.preventDefault();
	e.stopImmediatePropagation();
	// Số lượng mặc định
	quantity = 1;
	// Thẻ input quantity
	// Nếu có thẻ và giá trị của thẻ lớn hơn 0 thì set lại số lượng muốn thêm
	if ($(quantity_el).length > 0) {
		if ($(quantity_el).val() > 0) {
			quantity = $(quantity_el).val();
		}
	}
	// Dữ liệu thêm vào giỏ
	data = {
		product_id: product_id,
		quantity: quantity,
	};
	addCart(data);
}

function addCart(data) {
	$.ajax({
        headers: {
            'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
        },
        type: 'POST',
        url: '/ajax/shopping_cart/add',
        data: data,
        beforeSend: function(){
            $(".cart-loading").css({visibility:"visible", opacity: 0.0}).animate({opacity: 1.0},200);
        },
        success:function(result){
            $(".cart-loading").animate({opacity: 0.0}, 200, function(){
	            $(".cart-loading").css("visibility","hidden");
	        });
	        $('#cart-count').text(result.total_quantity);
	        // Mở box thông báo giỏ hàng
	        $('body').css('overflow', 'hidden');
	        $('#cart-add-popup').addClass('open').find('.cart-popup__body__notificate').html(result.message);
        },
        error: function (error) {
            /* Có lỗi sẽ ân Module Loading và thông báo */
            $(".cart-loading").animate({opacity: 0.0}, 200, function(){
	            $(".cart-loading").css("visibility","hidden");
	        });
	        // Mở box thông báo giỏ hàng
	        $('#cart-add-popup').addClass('open').find('.cart-popup__body__notificate').html('Có lỗi xảy ra. Vui lòng thử lại!');
        }
    });
}